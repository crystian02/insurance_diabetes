{% extends "ml/base.html" %}
{% load static %}

{% block content %}
<header class="main-header">
  <h1>üß† ML ‚Äì Seguros & Diabetes</h1>
  <p class="subtitle">Modelos predictivos para salud y costos m√©dicos</p>
  <nav class="tabs">
    <a href="?tab=insurance" {% if tab == 'insurance' %}class="active"{% endif %}>Seguro</a> |
    <a href="?tab=diabetes" {% if tab == 'diabetes' %}class="active"{% endif %}>Diabetes</a>
  </nav>
</header>

<main class="main-content {% if tab == 'diabetes' %}bg-diabetes{% else %}bg-insurance{% endif %}">
  
  <div class="overlay"></div>

  <div class="content">
    {% if tab == 'diabetes' %}
      <h2>Predicci√≥n de riesgo de diabetes</h2>
      <form id="f-dia" onsubmit="submitDia(event)">
        <label>Sexo:
          <select id="sexo" name="sex">
            <option value="female">Femenino</option>
            <option value="male">Masculino</option>
          </select>
        </label>

        <div id="embarazos-field">
          <label>Embarazos: 
            <input name="pregnancies" type="number" value="2" min="0">
          </label>
        </div>

        <label>Glucosa en sangre (mg/dL): <input name="glucose" type="number" value="120"></label>
        <label>Presi√≥n arterial diast√≥lica (mmHg): <input name="bloodpressure" type="number" value="70"></label>
        <label>Espesor de pliegue cut√°neo (mm): <input name="skinthickness" type="number" value="20"></label>
        <label>Insulina (ŒºU/mL): <input name="insulin" type="number" value="85"></label>

        <label>Peso (kg): <input type="number" id="weight" step="0.1" value="70"></label>
        <label>Altura (cm): <input type="number" id="height" step="0.1" value="170"></label>
        <label>√çndice de masa corporal (IMC): 
          <input name="bmi" id="bmi" type="number" step="0.1" readonly inputmode="none">
        </label>
        <small style="color:gray;display:block;margin-top:-4px;">
          Este indicador se calcula autom√°ticamente.
        </small>

        <fieldset style="margin-top:10px; border:1px solid #ccc; padding:10px;">
          <legend><b>Antecedentes familiares</b></legend>
          <label><input type="checkbox" class="fam" data-factor="0.6"> Padre o madre con diabetes</label><br>
          <label><input type="checkbox" class="fam" data-factor="0.4"> Alg√∫n abuelo/a con diabetes</label><br>
          <label><input type="checkbox" class="fam" data-factor="0.5"> Alg√∫n hermano/a con diabetes</label><br>
          <label><input type="checkbox" class="fam" data-factor="0.3"> Otros familiares con diabetes</label><br>
          <label>Riesgo familiar (DPF): 
            <input name="dpf" id="dpf" type="number" step="0.01" readonly>
          </label>
          <small id="dpf-label" style="margin-left:10px; color:gray"></small>
        </fieldset>

        <div id="riesgo-preview" style="font-weight:bold; margin-top:8px;"></div>

        <label>Edad (a√±os): <input name="age" type="number" value="35"></label>
        <button type="submit">Predecir riesgo de diabetes</button>
      </form>

      <div id="out-dia"></div>
      <div id="metrics">
        <h3>M√©tricas del modelo</h3>
        <ul>
          <li><b>ROC AUC:</b> 0.84</li>
          <li><b>F1 Score:</b> 0.65</li>
          <li><b>Modelo:</b> Logistic Regression</li>
        </ul>
      </div>

      <script>
      // Mostrar/ocultar campo de embarazos
      const sexoSelect = document.getElementById('sexo');
      const embarazosDiv = document.getElementById('embarazos-field');
      sexoSelect.addEventListener('change', () => {
        embarazosDiv.style.display = (sexoSelect.value === 'female') ? 'inline' : 'none';
      });
      embarazosDiv.style.display = (sexoSelect.value === 'female') ? 'inline' : 'none';

      // Calcular IMC
      function calcularBMI() {
        const peso = parseFloat(document.getElementById('weight').value);
        const altura = parseFloat(document.getElementById('height').value);
        if (peso > 0 && altura > 0) {
          const bmi = peso / Math.pow(altura / 100, 2);
          document.getElementById('bmi').value = bmi.toFixed(1);
        }
      }
      document.getElementById('weight').addEventListener('input', calcularBMI);
      document.getElementById('height').addEventListener('input', calcularBMI);
      calcularBMI();

      // Calcular riesgo familiar
      function calcularDPF() {
        let total = 0;
        document.querySelectorAll('.fam:checked').forEach(cb => {
          total += parseFloat(cb.dataset.factor);
        });
        if (total > 2) total = 2;
        document.getElementById('dpf').value = total.toFixed(2);
        let label = "Bajo", color = "#16a34a";
        if (total >= 1.5) { label = "Muy alto"; color = "#dc2626"; }
        else if (total >= 1.0) { label = "Alto"; color = "#ea580c"; }
        else if (total >= 0.6) { label = "Moderado"; color = "#facc15"; }
        else if (total >= 0.3) { label = "Leve"; color = "#65a30d"; }

        document.getElementById('dpf-label').textContent = `(${label} riesgo familiar)`;
        const preview = document.getElementById('riesgo-preview');
        preview.textContent = `Riesgo familiar: ${label}`;
        preview.style.color = color;
      }

      document.addEventListener("DOMContentLoaded", () => {
        calcularDPF();
        document.querySelectorAll('.fam').forEach(cb => {
          cb.addEventListener('change', calcularDPF);
        });
      });

      // Enviar datos
      async function submitDia(e){
        e.preventDefault();
        const fd = new FormData(e.target);
        const payload = Object.fromEntries(fd.entries());
        for (const k of Object.keys(payload)) {
          const val = parseFloat(payload[k]);
          payload[k] = isNaN(val) ? 0 : val;
        }
        if (isNaN(payload.dpf)) payload.dpf = parseFloat(document.getElementById('dpf').value) || 0.0;
        payload.age = parseInt(payload.age);
        if (payload.sex === 'male') payload.pregnancies = 0;

        const r = await fetch('/api/predict_diabetes', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await r.json();
        const jsonStr = JSON.stringify(data, null, 2);
        document.getElementById('out-dia').innerHTML = `
          <details>
            <summary>Ver detalle de c√°lculo</summary>
            <pre>${jsonStr}</pre>
          </details>
        `;

        const prob = data.probability ?? 0;
        const pct = (prob * 100).toFixed(1);
        let nivel = "bajo", color = "green", mensaje = "No se observan indicios relevantes de riesgo.";
        if (prob > 0.6) {
          nivel = "alto"; color = "red";
          mensaje = "Se recomienda evaluaci√≥n m√©dica y control glic√©mico peri√≥dico.";
        } else if (prob > 0.25) {
          nivel = "medio"; color = "orange";
          mensaje = "Riesgo moderado, se sugiere mantener h√°bitos saludables y chequeos regulares.";
        }

        const div = document.getElementById("resultado") || document.createElement("div");
        div.id = "resultado";
        div.style.marginTop = "15px";
        div.innerHTML = `
          <h3 style="color:${color}">Resultado: <b>Riesgo ${nivel.toUpperCase()}</b> (${pct}%)</h3>
          <p>${mensaje}</p>
        `;
        document.querySelector("#out-dia").after(div);
      }
      </script>

    {% else %}
      <h2>Predicci√≥n de costo de seguro m√©dico</h2>
      <form id="f-ins" onsubmit="submitIns(event)">
        <label>Edad: <input name="age" type="number" value="30"></label>
        <label>Peso (kg): <input type="number" id="weight" step="0.1" value="70"></label>
        <label>Altura (cm): <input type="number" id="height" step="0.1" value="170"></label>
        <label>IMC: <input name="bmi" id="bmi" type="number" step="0.1" readonly></label>
        <small style="color:gray;display:block;">Este indicador se calcula autom√°ticamente.</small>
        <label>Hijos: <input name="children" type="number" value="1"></label>
        <label>Fumador:
          <select name="smoker"><option value="no">No</option><option value="yes">S√≠</option></select>
        </label>
        <label>Sexo:
          <select name="sex"><option value="female">Femenino</option><option value="male">Masculino</option></select>
        </label>
        <label>Regi√≥n:
          <select name="region">
            <option value="northwest">Noroeste</option>
            <option value="northeast">Noreste</option>
            <option value="southeast">Sureste</option>
            <option value="southwest">Suroeste</option>
          </select>
        </label>
        <button type="submit">Predecir costo</button>
      </form>

      <div id="out-ins"></div>
      <div id="interpretacion"></div>
      <div id="metrics">
        <h3>M√©tricas del modelo</h3>
        <ul>
          <li><b>R¬≤ (Score):</b> 0.75</li>
          <li><b>MAE:</b> 2700.12</li>
          <li><b>RMSE:</b> 4100.54</li>
          <li><b>Modelo:</b> Linear Regression</li>
        </ul>
      </div>

      <script>
      async function submitIns(e){
        e.preventDefault();
        const fd = new FormData(e.target);
        const payload = Object.fromEntries(fd.entries());
        payload.age = parseInt(payload.age);
        payload.children = parseInt(payload.children);
        payload.bmi = parseFloat(payload.bmi);

        const r = await fetch('/api/predict_insurance', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await r.json();
        const jsonStr = JSON.stringify(data, null, 2);
        document.getElementById('out-ins').innerHTML = `
          <details>
            <summary>Ver detalle de c√°lculo</summary>
            <pre>${jsonStr}</pre>
          </details>
        `;

        const costo = data.predicted_cost ?? 0;
        const fumador = payload.smoker === 'yes';
        const bmi = payload.bmi;
        const edad = payload.age;

        let riesgo = "bajo", color = "green", mensaje = "El costo estimado del seguro es coherente con un perfil saludable.";
        if (fumador || bmi > 30 || edad > 55) {
          riesgo = "alto"; color = "red";
          mensaje = "El costo es elevado debido a factores de riesgo como tabaquismo, edad o sobrepeso.";
        } else if (bmi > 25 || edad > 40) {
          riesgo = "medio"; color = "orange";
          mensaje = "El costo es moderado. Mantener h√°bitos saludables puede reducirlo.";
        }

        const div = document.getElementById("interpretacion");
        div.innerHTML = `
          <h3 style="color:${color}">Costo estimado: <b>$${costo.toLocaleString("es-CL")}</b></h3>
          <p><b>Nivel de riesgo:</b> ${riesgo.toUpperCase()}</p>
          <p>${mensaje}</p>
        `;
      }

      // Calcular IMC
      function calcularBMI() {
        const peso = parseFloat(document.getElementById('weight').value);
        const altura = parseFloat(document.getElementById('height').value);
        if (peso > 0 && altura > 0) {
          const bmi = peso / Math.pow(altura / 100, 2);
          document.getElementById('bmi').value = bmi.toFixed(1);
        }
      }
      document.getElementById('weight').addEventListener('input', calcularBMI);
      document.getElementById('height').addEventListener('input', calcularBMI);
      calcularBMI();
      </script>
    {% endif %}
  </div>
</main>
{% endblock %}